<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdn.plyr.io/3.7.2/plyr.css">

<style>
:root {
  --bg-dark:#06070a;
  --accent-grad:linear-gradient(90deg,#f7a42b,#f45c9f);
  --muted-white:rgba(255,255,255,0.92);
  --soft-shadow:0 6px 18px rgba(0,0,0,0.6);
}

body, html {
  margin:0; padding:0;
  background:var(--bg-dark);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  color:var(--muted-white);
  overflow-x:hidden;
}

#video-wrap { 
  max-width:1100px; 
  margin:20px auto; 
}

#video-card { 
  border-radius:12px; 
  overflow:hidden; 
  position:relative; 
  box-shadow:var(--soft-shadow); 
  background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.25)); 
  border:1px solid rgba(255,255,255,0.03); 
}

/* Ajuste Blogger: proporci贸n 16:9 sin romper flujo */
#video-container {
  position: relative;
  width: 100%;
  background: #000;
  overflow: hidden;
}
#video-container::before {
  content: "";
  display: block;
  padding-bottom: 56.25%; /* 16:9 */
}
#video-container > video,
#video-container > div {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
}

/* Fullscreen */
:fullscreen #video-container,
:-webkit-full-screen #video-container,
:-moz-full-screen #video-container {
  width: 100% !important;
  height: 100% !important;
  border-radius: 0;
}

/* Plyr Disney+ */
.plyr { --plyr-control-spacing:8px; --plyr-color-main:#ffffff; --plyr-radius:10px; }
.plyr__controls { background: linear-gradient(180deg, rgba(8,9,12,0.45), rgba(8,9,12,0.3)); backdrop-filter:blur(6px); border-top:1px solid rgba(255,255,255,0.03); padding:10px; }
.plyr__progress--played { background-image: var(--accent-grad); height:6px; border-radius:999px; }
.plyr__progress__buffer { background: linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)); height:6px; border-radius:999px; }
.plyr__progress__knob { width:14px; height:14px; border-radius:50%; transform: translateY(-4px); box-shadow:0 6px 18px rgba(0,0,0,0.45); background:white; border:2px solid rgba(255,255,255,0.95); }
.plyr__control:hover { transform: translateY(-2px); filter: drop-shadow(0 4px 12px rgba(247,164,43,0.08)); }
.plyr__control:focus, .plyr__control--pressed { outline:none; box-shadow:0 0 0 4px rgba(247,164,43,0.08); }
.plyr__menu, .plyr__time { color:var(--muted-white); background: rgba(8,9,12,0.88); border-radius:10px; border:1px solid rgba(255,255,255,0.03); }

.seek-feedback { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:50px; height:50px; border-radius:50%; border:1px solid rgba(255,255,255,0.1); background:rgba(255,255,255,0.02,0.5); display:flex; justify-content:center; align-items:center; opacity:0; transition: opacity .22s, transform .22s; }
.seek-feedback.show { opacity:1; transform:translate(-50%,-55%); animation:fadeInOut 0.7s forwards; }

#loading-overlay { position:absolute; top:0; left:0; width:100%; height:100%; display:flex; justify-content:center; align-items:center; background:#000; z-index:1000; flex-direction:column; transition:opacity .5s ease; pointer-events:auto; }
#loading-overlay.hide { opacity:0; pointer-events:none; }

#loading-bar { width:0%; height:4px; background:var(--accent-grad); margin-top:10px; border-radius:2px; }

#intro-logo { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:250px; height:auto; opacity:0; transition: opacity 1.2s ease; z-index:2000; }
#intro-logo.show { opacity:1; animation:fadeInOut 3s forwards; }

@keyframes fadeInOut { 0%{opacity:0} 20%{opacity:1} 80%{opacity:1} 100%{opacity:0} }

</style>
</head>
<body>

<div id="video-wrap">
  <div id="video-card">
    <div id="video-container" role="region" aria-label="Video player">
      <video id="player" playsinline></video>

      <div id="seekFeedback" class="seek-feedback">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
          <path d="M12 6v6l4 2" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="9" stroke="white" stroke-opacity="0.15" stroke-width="1.2"/>
        </svg>
      </div>

      <div id="loading-overlay">
        <img id="intro-logo" src="https://blogger.googleusercontent.com/img/a/AVvXsEgrc23VOKiDqYPo92EdvxiSlbGiq2pWAA3WCcRGShax913ZCTqLoUN47Q-b2Ecbdd0pbjxxHMlXKYn07H1WhgLR7zFoqAekBf5BnoLD9LX882taGZZsbwm7lrUAW5trrLPiu0KaY59913jLfEZhhlW_PY15ss59Z1S7QCfRAPaTsWtYm-Hx9uqWd_3NbdY=s166" alt="Logo">
        <div id="loading-bar"></div>
      </div>
    </div>
  </div>
</div>

<div id="errorMessage" style="text-align:center;color:#f55;font-weight:600;padding:10px;display:none;"></div>

<script src="https://cdn.jsdelivr.net/npm/shaka-player@latest/dist/shaka-player.compiled.js"></script>
<script src="https://cdn.plyr.io/3.7.2/plyr.js"></script>

<script>
(async function(){
  const video=document.getElementById('player');
  const container=document.getElementById('video-container');
  const errorMessage=document.getElementById('errorMessage');
  const seekFeedback=document.getElementById('seekFeedback');
  const loadingOverlay=document.getElementById('loading-overlay');
  const introLogo=document.getElementById('intro-logo');

  const mpdUrl="https://el4live1.boldmss.com/LIFETIME/LIFETIME_EL4.isml/LIFETIME_EL4.mpd";
  const clearKeys={"decf9d08f51a4f9cb0b1ae58430a27a8":"88f75b9621953b1953825b02e0aafde2"};

  try{ shaka.polyfill.installAll(); }catch(e){ console.warn('shaka.polyfill.installAll fall贸', e); }

  if(!shaka.Player.isBrowserSupported()){
    errorMessage.textContent='Este navegador no soporta Shaka Player.';
    errorMessage.style.display='block';
    return;
  }

  try{
    const player=new shaka.Player(video);

    player.configure({
      drm:{ clearKeys },
      abr:{ enabled:true, defaultBandwidthEstimate:5000000 },
      streaming:{ 
        bufferingGoal:1, 
        rebufferingGoal:5, 
        lowLatencyMode:true, 
        stallSkip:true, 
        retryParameters:{ maxAttempts:2, baseDelay:200, backoffFactor:1.7, fuzzFactor:0.25, timeout:6000 } 
      },
      preferredAudioLanguage: 'es'
    });

    if(!sessionStorage.getItem('introShown')){
      introLogo.classList.add('show');
      setTimeout(()=>{
        introLogo.classList.remove('show');
        loadingOverlay.classList.add('hide');
        sessionStorage.setItem('introShown','true');
        video.play().catch(()=>{});
      },3000);
    } else {
      loadingOverlay.classList.add('hide');
      video.play().catch(()=>{});
    }

    await player.load(mpdUrl);

    const plyrInstance=new Plyr(video,{
      controls:['play-large','rewind','play','fast-forward','progress','current-time','mute','volume','settings','pip','fullscreen'],
      settings:['quality','speed','loop'],
      autoplay:true,
      keyboard:{ global:true }
    });

    const SEEK_STEP = 10;

    document.addEventListener('click', e=>{
      const rewindBtn=e.target.closest('.plyr__control--rewind');
      const ffBtn=e.target.closest('.plyr__control--fast-forward');
      if(rewindBtn) showFeedback(-SEEK_STEP);
      else if(ffBtn) showFeedback(SEEK_STEP);
    });

    function showFeedback(amount){
      try{ 
        const dur = isFinite(video.duration) ? video.duration : Infinity; 
        video.currentTime = Math.max(0, Math.min((video.currentTime||0)+amount, dur)); 
      } catch(e){}
      seekFeedback.classList.remove('show'); 
      void seekFeedback.offsetWidth; 
      seekFeedback.classList.add('show'); 
      clearTimeout(seekFeedback._timeout);
      seekFeedback._timeout = setTimeout(() => seekFeedback.classList.remove('show'), 700);
    }

    try{
      const exclude=/SmartTV|Tizen|Web0S|WebOS|SmartHub|Chromecast|AppleTV|Roku|FireTV|AndroidTV|VIdaa|iPhone|iPad|iPod|Android/i;
      if(!exclude.test(navigator.userAgent) && window.AudioContext){
        const audioCtx=new (window.AudioContext||window.webkitAudioContext)();
        const source=audioCtx.createMediaElementSource(video);
        const gainNode=audioCtx.createGain();
        gainNode.gain.value=2;
        source.connect(gainNode);
        gainNode.connect(audioCtx.destination);
      }
    }catch(err){console.warn('Audio boost fall贸',err);}

    video.muted=false; video.volume=1;
    function tryPlay(){ video.play().catch(err=>console.log('Autoplay bloqueado',err)); }
    tryPlay();
    function onFirstInteraction(){ video.muted=false; video.volume=1; tryPlay(); window.removeEventListener('click',onFirstInteraction); window.removeEventListener('keydown',onFirstInteraction); window.removeEventListener('touchstart',onFirstInteraction);}
    window.addEventListener('click',onFirstInteraction);
    window.addEventListener('keydown',onFirstInteraction);
    window.addEventListener('touchstart',onFirstInteraction);

    plyrInstance.on('enterfullscreen',async()=>{
      try{ 
        if(container.requestFullscreen) await container.requestFullscreen();
        else if(container.webkitRequestFullscreen) await container.webkitRequestFullscreen();
        else if(container.msRequestFullscreen) await container.msRequestFullscreen();
        if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape').catch(()=>{});
      }catch(e){}
    });
    plyrInstance.on('exitfullscreen',async()=>{
      try{ if (screen.orientation && screen.orientation.unlock) await screen.orientation.unlock().catch(()=>{}); }catch(e){}
    });

    player.addEventListener('trackschanged', () => {
      try {
        const variants = player.getVariantTracks();
        if (!variants || variants.length === 0) return;
        const esTrack = variants.find(t => t.language && t.language.toLowerCase().startsWith('es'));
        if (esTrack) {
          player.selectAudioLanguage('es');
          player.selectVariantTrack(esTrack, true);
          console.log(' Audio forzado a Espa帽ol (track selected):', esTrack);
        }
      } catch (err) {
        console.warn('Error al forzar audio espa帽ol:', err);
      }
    });

    player.addEventListener('error',evt=>{
      const err=evt.detail;
      console.error('Shaka error',err);
      errorMessage.textContent='Error de reproducci贸n: '+(err&&err.message?err.message:'desconocido');
      errorMessage.style.display='block';
    });

    video.addEventListener('progress', () => {
      try{
        const bar=document.getElementById('loading-bar');
        if(video.buffered.length){
          const bufferedEnd = video.buffered.end(video.buffered.length-1);
          const duration = video.duration || 1;
          const pct = Math.min(100, (bufferedEnd / duration) * 100);
          bar.style.width = pct + '%';
        }
      }catch(e){}
    });

    video.addEventListener('playing', ()=>{
      loadingOverlay.classList.add('hide');
      introLogo.classList.remove('show');
    });

  }catch(err){
    console.error('Error reproductor',err);
    errorMessage.textContent='Error al inicializar: '+(err.message||err);
    errorMessage.style.display='block';
  }
})();
</script>

</body>
</html>
